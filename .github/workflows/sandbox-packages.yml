name: Sandbox Package Audit

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - "crates/config/src/schema.rs"
      - ".github/workflows/sandbox-packages.yml"
  workflow_dispatch:

permissions: {}

jobs:
  dump-packages:
    name: Dump Ubuntu 25.10 packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
    container:
      image: ubuntu:25.10
    steps:
      - name: List all installed packages
        run: |
          dpkg -l | awk '/^ii/ {print $2}' | sort > /tmp/runner-packages.txt
          echo "### Packages installed in ubuntu:25.10"
          echo "Total: $(wc -l < /tmp/runner-packages.txt)"
          echo ""
          cat /tmp/runner-packages.txt

      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          persist-credentials: false

      - name: Extract moltis default packages from schema.rs
        run: |
          grep -oP '"[a-z][a-z0-9._+-]*"' crates/config/src/schema.rs \
            | tr -d '"' | sort -u > /tmp/moltis-packages.txt
          echo "### Moltis default sandbox packages"
          cat /tmp/moltis-packages.txt

      - name: Compare
        run: |
          echo "### Packages in moltis defaults but NOT in base ubuntu:25.10 (will be installed)"
          comm -23 /tmp/moltis-packages.txt /tmp/runner-packages.txt || true
          echo ""
          echo "### Packages in base ubuntu:25.10 but NOT in moltis defaults (already available)"
          comm -13 /tmp/moltis-packages.txt /tmp/runner-packages.txt || true
